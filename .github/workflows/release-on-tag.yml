name: mcpserver-stdio-bundle-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build/release (e.g. v1.2.3). If omitted on push event, ref_name is used."
        required: false
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

env:
  PROJECT_NAME: mcpserver-stdio-bundle
  JAR_BASENAME: mcpserver-stdio
  CLASSIFIER: bundle

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi

          if [[ -z "$TAG" ]]; then
            echo "ERROR: tag is empty" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.tag }}
          fetch-depth: 0

      - name: Validate tag and extract version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ref.outputs.tag }}"
          if [[ ! "$TAG" =~ ^v[0-9]+(\.[0-9]+)*$ ]]; then
            echo "ERROR: invalid tag '$TAG' (expected: v<digits(.digits)*>)" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          JAR="${{ env.JAR_BASENAME }}-${VERSION}-${{ env.CLASSIFIER }}.jar"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "jar=$JAR" >> "$GITHUB_OUTPUT"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Build bundle jar (shadowJar only)
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew --no-daemon clean shadowJar -PmcpVersion='${{ steps.ver.outputs.version }}'
          test -f "build/libs/${{ steps.ver.outputs.jar }}"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.ver.outputs.jar }}
          path: build/libs/${{ steps.ver.outputs.jar }}
          if-no-files-found: error

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          provenance: true
          sbom: true
          build-args: |
            JAR_FILE=build/libs/${{ steps.ver.outputs.jar }}
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.ver.outputs.version }}
            ghcr.io/${{ github.repository }}:${{ steps.ver.outputs.tag }}
            ghcr.io/${{ github.repository }}:latest

      - name: Create GitHub Release (bundle + docker)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ env.PROJECT_NAME }} ${{ steps.ver.outputs.tag }}
          generate_release_notes: false
          files: build/libs/${{ steps.ver.outputs.jar }}
          body: |
            **Bundle (fat JAR)** for IntelliJ MCP stdio runner.

            Run:
            `java -jar ${{ steps.ver.outputs.jar }}`

            **Docker image** (GHCR):
            - `ghcr.io/${{ github.repository }}:${{ steps.ver.outputs.version }}`
            - `ghcr.io/${{ github.repository }}:${{ steps.ver.outputs.tag }}`
            - `ghcr.io/${{ github.repository }}:latest`

            - Project: **${{ env.PROJECT_NAME }}**
            - Version: **${{ steps.ver.outputs.version }}**
            - Packaging: **bundle / fat JAR (zip64 enabled)**
            - Main-Class: `com.intellij.mcpserver.stdio.McpStdioRunnerKt`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
